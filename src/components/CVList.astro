---
import {CvItem, CvList} from "../../Backend/schemaTypes/CVList";
import '../styles/CVList.css'
const cvListProps : CvList = Astro.props;

---

<section id="cvListWrapper" class="cvListWrapper">
    <div class="cvListInner">
        <canvas id="canvas" class="canvas"></canvas>
    {cvListProps.cvItemList.map((item: CvItem, index : number) => {
        const direction = (index % 2 === 0)  ? 'Left' : 'Right';
        return(

            <div class={`cvListItem${direction}`}>
                <h2 class="text">{item.headline}</h2>
                <h3 class="text">{item.date}</h3>
                <p class="text">{item.text}</p>
            </div>
        )
    })}
    </div>
</section>


<script>

    document.addEventListener('DOMContentLoaded', () => {
        const cvItems = document.querySelectorAll('.cvListItemLeft, .cvListItemRight');
        const numberCVListItems = cvItems.length;
        const canvas = document.getElementById('canvas') as HTMLCanvasElement;
        const ctx = canvas.getContext("2d");
        const cvListWrapper = document.getElementById('cvListWrapper');
        if(cvListWrapper) {
            canvas.width = cvListWrapper.offsetWidth
            canvas.height = cvListWrapper.offsetHeight;
        }

        if(!ctx) return;

        ctx.strokeStyle = 'white';
        ctx.lineWidth = 4;
        let minHeight = canvas.height/numberCVListItems
        let currentHeight = minHeight;
        drawLine(minHeight);
        setItemVisebel(currentHeight);
        let targetHeight = currentHeight;
        const easing = 0.1;

        function animateLine() {
            if (!ctx) return;
            currentHeight += (targetHeight - currentHeight) * easing;
            drawLine(currentHeight);
            setItemVisebel(currentHeight);
            if (Math.abs(targetHeight - currentHeight) > 0.5) {
                requestAnimationFrame(animateLine);
            }
        }


        function drawLine(newHeight: number) {
            ctx?.clearRect(0, 0, canvas.width, canvas.height);
            ctx?.beginPath();
            ctx?.moveTo(screen.width/2, 0);
            ctx?.lineTo(screen.width/2, newHeight);
            ctx?.stroke();

        }

        function setItemVisebel(currentHeight: number) {
            for(let i = 0; i < numberCVListItems; i++){
                if(currentHeight <= ((i+1)*canvas.height/numberCVListItems)+50
                    && currentHeight > ((i+1)*canvas.height/numberCVListItems)-50){
                    cvItems[i].style.opacity = '1';
                }
            }
        }

        function lockLineInMaxHeight() {
            minHeight = canvas.height;
        }


        window.addEventListener('wheel', (e) => {
            targetHeight += e.deltaY;
            if (targetHeight < minHeight) targetHeight = minHeight;
            if (targetHeight > canvas.height) {
                targetHeight = canvas.height;
                lockLineInMaxHeight();
            }
            animateLine();
        });

    });

</script>



